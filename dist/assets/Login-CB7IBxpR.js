import{j as e,k,D as x,B as h,N as O,O as D}from"./ui-components-CL-10tNC.js";import{u as I,h as R,r as n}from"./react-vendor-NfsKhbMh.js";import{a as W}from"./index-DNL726t5.js";import"./supabase-DQ7Oc2S5.js";const P=()=>{var b,v;const l=I(),w=R(),{signIn:A,verifyMfaCode:S,is2FARequired:d,isSuperAdmin:a,signOut:p,loading:o}=W(),[c,L]=n.useState(""),[u,C]=n.useState(""),[g,f]=n.useState(""),[y,r]=n.useState(null),[j,m]=n.useState(!1),i=((v=(b=w.state)==null?void 0:b.from)==null?void 0:v.pathname)||"/admin";n.useEffect(()=>{console.log("Login: Component mounted or isSuperAdmin changed. Current isSuperAdmin:",a),console.log("Login: Current authLoading:",o),!o&&a&&(console.log("Login: isSuperAdmin is true, navigating to:",i),l(i,{replace:!0}))},[a,o,l,i]);const F=async t=>{t.preventDefault(),r(null),m(!0),console.log("Login: handleSubmit called. Attempting sign-in for:",c);try{const{error:s,userRole:N}=await A(c,u);if(s)throw console.error("Login: Sign-in error:",s),s;if(console.log("Login: Sign-in successful. Checking userRole from signIn response:",N),N!=="superadmin"){console.log("Login: User is NOT superadmin based on signIn response. Signing out."),await p(),r("Access Denied: Only superadmins can access this portal.");return}d||(console.log("Login: is2FARequired is false, navigating to:",i),l(i,{replace:!0}))}catch(s){r(s.message||"Failed to sign in")}finally{m(!1),console.log("Login: handleSubmit finished. Final isSuperAdmin (from state):",a)}},E=async t=>{t.preventDefault(),r(null),m(!0),console.log("Login: handleVerify2FA called. Attempting 2FA verification.");try{const{error:s}=await S(g);if(s)throw console.error("Login: 2FA verification error:",s),s;if(console.log("Login: 2FA verification successful. Checking isSuperAdmin (from state):",a),!a){console.log("Login: User is NOT superadmin after 2FA. Signing out."),await p(),r("Access Denied: Only superadmins can access this portal.");return}l(i,{replace:!0})}catch(s){r(s.message||"Invalid verification code")}finally{m(!1),console.log("Login: handleVerify2FA finished. Final isSuperAdmin (from state):",a)}};return o?(console.log("Login: AuthContext is still loading..."),e.jsx("div",{className:"min-h-screen bg-gray-50 flex flex-col justify-center py-12 sm:px-6 lg:px-8",children:e.jsx("div",{className:"sm:mx-auto sm:w-full sm:max-w-md text-center",children:e.jsx("p",{className:"text-gray-600",children:"Loading authentication state..."})})})):e.jsxs("div",{className:"min-h-screen bg-gray-50 flex flex-col justify-center py-12 sm:px-6 lg:px-8",children:[e.jsxs("div",{className:"sm:mx-auto sm:w-full sm:max-w-md",children:[e.jsx("div",{className:"flex justify-center",children:e.jsx("div",{className:"bg-blue-600 p-3 rounded-full",children:e.jsx(k,{className:"h-12 w-12 text-white"})})}),e.jsx("h2",{className:"mt-6 text-center text-3xl font-extrabold text-gray-900",children:"Mall Admin Portal"}),e.jsx("p",{className:"mt-2 text-center text-sm text-gray-600",children:d?"Enter your two-factor authentication code":"Sign in to manage your mall's stores and products"})]}),e.jsx("div",{className:"mt-8 sm:mx-auto sm:w-full sm:max-w-md",children:e.jsxs("div",{className:"bg-white py-8 px-4 shadow sm:rounded-lg sm:px-10",children:[y&&e.jsx("div",{className:"mb-4 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded relative",role:"alert",children:e.jsx("span",{className:"block sm:inline",children:y})}),d?e.jsxs("form",{className:"space-y-6",onSubmit:E,children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4",children:e.jsx(O,{className:"h-6 w-6 text-blue-600"})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Two-Factor Authentication"}),e.jsx("p",{className:"text-sm text-gray-600 mb-6",children:"Enter the 6-digit code from your authenticator app"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(x,{label:"Authentication Code",type:"text",value:g,onChange:t=>f(t.target.value.replace(/\D/g,"").slice(0,6)),placeholder:"000000",required:!0,fullWidth:!0,className:"text-center text-lg font-mono tracking-widest",maxLength:6,autoComplete:"one-time-code"}),e.jsxs("div",{className:"flex items-center text-sm text-gray-600",children:[e.jsx(D,{className:"h-4 w-4 mr-2"}),e.jsx("span",{children:"Open your authenticator app to get the code"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(h,{type:"submit",variant:"primary",fullWidth:!0,isLoading:j,disabled:g.length!==6,children:"Verify Code"}),e.jsx(h,{type:"button",variant:"ghost",fullWidth:!0,onClick:()=>{f(""),r(null),window.location.reload()},children:"Back to Login"})]}),e.jsx("div",{className:"mt-6 text-center",children:e.jsx("p",{className:"text-xs text-gray-500",children:"Having trouble? Contact your system administrator for help."})})]}):e.jsxs("form",{className:"space-y-6",onSubmit:F,children:[e.jsx(x,{label:"Email address",type:"email",value:c,onChange:t=>L(t.target.value),required:!0,fullWidth:!0,autoComplete:"email"}),e.jsx(x,{label:"Password",type:"password",value:u,onChange:t=>C(t.target.value),required:!0,fullWidth:!0,autoComplete:"current-password"}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{id:"remember-me",name:"remember-me",type:"checkbox",className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),e.jsx("label",{htmlFor:"remember-me",className:"ml-2 block text-sm text-gray-900",children:"Remember me"})]}),e.jsx("div",{className:"text-sm",children:e.jsx("a",{href:"#",className:"font-medium text-blue-600 hover:text-blue-500",children:"Forgot your password?"})})]}),e.jsx(h,{type:"submit",variant:"primary",fullWidth:!0,isLoading:j,disabled:!c||!u,children:"Sign in"})]})]})})]})};export{P as default};
