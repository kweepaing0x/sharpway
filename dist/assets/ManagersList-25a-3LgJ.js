import{s as b,j as e,B as p,m as q,S as O,a8 as Z,a9 as U,aa as G,ab as Q,T as V,u as $,v as X}from"./ui-components-CL-10tNC.js";import{r as d,L as T}from"./react-vendor-NfsKhbMh.js";import"./supabase-DQ7Oc2S5.js";const W=()=>{const[S,f]=d.useState([]),[j,w]=d.useState(!0),[_,i]=d.useState(null),[N,A]=d.useState(""),[D,v]=d.useState(null),[y,M]=d.useState(""),[l,m]=d.useState(null),[E,u]=d.useState(null),x=d.useCallback(async()=>{try{w(!0),console.log("ManagersList: Starting to fetch managers...");const{data:s,error:t}=await b.from("store_managers").select(`
          id,
          user_id,
          store_id,
          is_active,
          created_at,
          updated_at
        `).order("created_at",{ascending:!1});if(t)throw console.error("ManagersList: Error fetching store_managers:",t),t;if(console.log("ManagersList: Raw store_managers data:",s),!s||s.length===0){console.log("ManagersList: No store managers found"),f([]),i(null),w(!1);return}const r=s.map(o=>o.user_id),a=s.map(o=>o.store_id);console.log("ManagersList: User IDs to fetch:",r),console.log("ManagersList: Store IDs to fetch:",a);const{data:n,error:c}=await b.from("users").select("id, email, role, created_at").in("id",r).eq("role","store-manager");if(c)throw console.error("ManagersList: Error fetching users:",c),c;console.log("ManagersList: Users data:",n);const{data:g,error:L}=await b.from("stores").select("id, name, location, is_active").in("id",a);if(L)throw console.error("ManagersList: Error fetching stores:",L),L;console.log("ManagersList: Stores data:",g);const z=s.map(o=>{const h=n==null?void 0:n.find(C=>C.id===o.user_id),I=g==null?void 0:g.find(C=>C.id===o.store_id);return{...o,users:h?{email:h.email,role:h.role}:null,stores:I?{name:I.name,location:I.location}:null}});console.log("ManagersList: Combined managers data:",z);const J=z.filter(o=>{const h=o.users&&o.users.email&&o.stores&&o.stores.name;return h||console.log("ManagersList: Filtering out invalid manager:",o),h});console.log("ManagersList: Valid managers after filtering:",J),f(J),i(null)}catch(s){console.error("ManagersList: Error in fetchManagers:",s),i(s.message)}finally{w(!1)}},[]);d.useEffect(()=>{x()},[x]);const P=async(s,t)=>{console.log("ManagersList: Toggling manager status:",{id:s,isActive:t}),m(s),i(null);try{const r=!t,{error:a}=await b.from("store_managers").update({is_active:r}).eq("id",s);if(a)throw console.error("ManagersList: Error updating manager status:",a),a;console.log("ManagersList: Manager status updated successfully"),f(n=>n.map(c=>c.id===s?{...c,is_active:r}:c)),u(`Manager status ${r?"activated":"deactivated"} successfully`),setTimeout(()=>u(null),3e3)}catch(r){console.error("ManagersList: Error updating manager status:",r),i(r.message),await x()}finally{m(null)}},R=async(s,t)=>{if(confirm("Are you sure you want to delete this manager? This action cannot be undone.")){console.log("ManagersList: Deleting manager:",{managerId:s,userId:t}),m(s),i(null);try{const r=await fetch("https://omzqjvehfhjtfrphzuax.supabase.co/functions/v1/delete-manager",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9tenFqdmVoZmhqdGZycGh6dWF4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NzAzMDIsImV4cCI6MjA2NjM0NjMwMn0.JLHxw99HYn0z2S0uWt6shQGlqTeQNKNagoAlbNCb0nQ"},body:JSON.stringify({userId:t,managerId:s})});if(console.log("ManagersList: Delete response status:",r.status),!r.ok){const a=await r.json();throw console.error("ManagersList: Delete error response:",a),new Error(a.error||"Failed to delete manager")}console.log("ManagersList: Manager deleted successfully"),f(a=>a.filter(n=>n.id!==s)),u("Manager deleted successfully"),setTimeout(()=>u(null),3e3)}catch(r){console.error("ManagersList: Error deleting manager:",r),i(r.message),await x()}finally{m(null)}}},F=async s=>{if(!y){i("Password cannot be empty");return}if(y.length<6){i("Password must be at least 6 characters");return}console.log("ManagersList: Resetting password for user:",s),m(s),i(null);try{const t=await fetch("https://omzqjvehfhjtfrphzuax.supabase.co/functions/v1/reset-manager-password",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9tenFqdmVoZmhqdGZycGh6dWF4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NzAzMDIsImV4cCI6MjA2NjM0NjMwMn0.JLHxw99HYn0z2S0uWt6shQGlqTeQNKNagoAlbNCb0nQ"},body:JSON.stringify({userId:s,newPassword:y})});if(console.log("ManagersList: Reset password response status:",t.status),!t.ok){const r=await t.json();throw console.error("ManagersList: Reset password error response:",r),new Error(r.error||"Failed to reset password")}console.log("ManagersList: Password reset successfully"),v(null),M(""),u("Password reset successfully"),setTimeout(()=>u(null),3e3)}catch(t){console.error("ManagersList: Error resetting password:",t),i(t.message)}finally{m(null)}},k=S.filter(s=>{var t,r,a,n;return((r=(t=s.users)==null?void 0:t.email)==null?void 0:r.toLowerCase().includes(N.toLowerCase()))||((n=(a=s.stores)==null?void 0:a.name)==null?void 0:n.toLowerCase().includes(N.toLowerCase()))});return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"sm:flex sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Store Managers"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"Add or remove store manager access"})]}),e.jsx("div",{className:"mt-4 sm:mt-0",children:e.jsx(T,{to:"/admin/managers/new",children:e.jsxs(p,{variant:"primary",children:[e.jsx(q,{className:"h-4 w-4 mr-1"}),"Add Manager"]})})})]}),_&&e.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded relative",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:_}),e.jsx("button",{className:"text-red-700 hover:text-red-900",onClick:()=>i(null),children:"×"})]})}),E&&e.jsx("div",{className:"bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded relative",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:E}),e.jsx("button",{className:"text-green-700 hover:text-green-900",onClick:()=>u(null),children:"×"})]})}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("div",{className:"relative rounded-md flex-grow",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(O,{className:"h-5 w-5 text-gray-400"})}),e.jsx("input",{type:"text",placeholder:"Search managers...",className:"block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm",value:N,onChange:s=>A(s.target.value)})]}),e.jsxs(p,{variant:"secondary",onClick:x,disabled:j,children:[e.jsx(Z,{className:`h-4 w-4 mr-1 ${j?"animate-spin":""}`}),j?"Refreshing...":"Refresh"]})]}),j?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"}),e.jsx("p",{className:"mt-4 text-gray-500",children:"Loading managers..."})]}):k.length>0?e.jsx("div",{className:"bg-white shadow overflow-hidden sm:rounded-md",children:e.jsx("ul",{className:"divide-y divide-gray-200",children:k.map(s=>{var t,r,a,n,c;return e.jsx("li",{children:e.jsx("div",{className:"px-4 py-4 sm:px-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("div",{className:"h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center",children:e.jsx("span",{className:"text-blue-600 font-medium",children:((r=(t=s.users)==null?void 0:t.email)==null?void 0:r[0].toUpperCase())||"M"})})}),e.jsxs("div",{className:"ml-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:((a=s.users)==null?void 0:a.email)||"No Email"}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Managing: ",((n=s.stores)==null?void 0:n.name)||"No Store",(c=s.stores)!=null&&c.location?` (${s.stores.location})`:""]}),e.jsxs("p",{className:"text-xs text-gray-400",children:["User ID: ",s.user_id," | Manager ID: ",s.id]})]})]})}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:`px-2 py-1 text-xs font-medium rounded-full ${s.is_active?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:s.is_active?"Active":"Inactive"}),D===s.user_id?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"password",value:y,onChange:g=>M(g.target.value),placeholder:"New password",className:"text-sm border rounded-md px-2 py-1",minLength:6}),e.jsx("button",{onClick:()=>F(s.user_id),disabled:l===s.user_id,className:"px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 disabled:opacity-50",children:l===s.user_id?"Saving...":"Save"}),e.jsx("button",{onClick:()=>{v(null),M("")},className:"px-2 py-1 bg-gray-200 text-gray-800 text-xs rounded hover:bg-gray-300",children:"Cancel"})]}):e.jsxs("button",{onClick:()=>v(s.user_id),disabled:l===s.user_id,className:"px-2 py-1 bg-blue-50 text-blue-600 text-xs font-medium rounded hover:bg-blue-100 flex items-center disabled:opacity-50",children:[e.jsx(U,{className:"h-3 w-3 mr-1"}),"Reset Password"]}),e.jsxs(p,{variant:s.is_active?"danger":"primary",onClick:()=>P(s.id,s.is_active),isLoading:l===s.id,disabled:l===s.id,className:"text-sm px-2 py-1 h-auto",children:[l===s.id?e.jsx("div",{className:"animate-spin h-3 w-3 border-b-2 border-current rounded-full mr-1"}):s.is_active?e.jsx(G,{className:"h-3 w-3 mr-1"}):e.jsx(Q,{className:"h-3 w-3 mr-1"}),l===s.id?"Updating...":s.is_active?"Deactivate":"Activate"]}),e.jsxs(p,{variant:"danger",onClick:()=>R(s.id,s.user_id),isLoading:l===s.id,disabled:l===s.id,className:"text-sm px-2 py-1 h-auto",children:[l===s.id?e.jsx("div",{className:"animate-spin h-3 w-3 border-b-2 border-current rounded-full mr-1"}):e.jsx(V,{className:"h-3 w-3 mr-1"}),l===s.id?"Deleting...":"Delete"]})]})]})})},s.id)})})}):e.jsx($,{children:e.jsxs(X,{className:"py-12 text-center",children:[e.jsx("p",{className:"text-gray-500",children:"No store managers found."}),e.jsx("p",{className:"text-sm text-gray-400 mt-2",children:S.length===0?"Try creating a store with a manager account first.":"No managers match your search criteria."}),e.jsx(T,{to:"/admin/managers/new",className:"mt-4 inline-block",children:e.jsx(p,{variant:"primary",children:"Add your first manager"})})]})})]})};export{W as default};
