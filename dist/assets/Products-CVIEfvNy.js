import{s as n,j as e,B as p,m as z,S as G,a8 as H,a4 as E,T as A}from"./ui-components-CL-10tNC.js";import{r as a,L as P}from"./react-vendor-NfsKhbMh.js";import{P as J}from"./PriceDisplay-BLSyXYBn.js";import"./supabase-DQ7Oc2S5.js";import"./stores-BBDuH2RS.js";const Z=()=>{const[u,x]=a.useState([]),[q,j]=a.useState(!0),[m,L]=a.useState(""),[b,o]=a.useState(null),[O,D]=a.useState([]),[i,v]=a.useState(""),[w,T]=a.useState([]),[I,M]=a.useState([]),[h,f]=a.useState(""),[N,_]=a.useState(null),[l,c]=a.useState({display_order:0,is_visible:!0,starts_at:"",ends_at:""}),k=a.useCallback(async()=>{try{const{data:{user:s},error:r}=await n.auth.getUser();if(r)throw r;const{data:t,error:g}=await n.from("store_managers").select(`
          *,
          stores!inner(*)
        `).eq("user_id",s==null?void 0:s.id).eq("is_active",!0);if(g)throw g;const y=(t==null?void 0:t.map(V=>V.stores))||[];D(y),y.length>0&&!i&&v(y[0].id)}catch(s){console.error("Error fetching managed stores:",s),o(s.message)}},[i]);a.useEffect(()=>{k()},[k]);const d=a.useCallback(async()=>{if(i){j(!0);try{const{data:s,error:r}=await n.from("products").select(`
          *,
          stores!inner(
            id,
            name
          )
        `).eq("store_id",i).order("created_at",{ascending:!1});if(r)throw r;x(s||[])}catch(s){console.error("Error fetching products:",s),o(s.message)}finally{j(!1)}}},[i]);a.useEffect(()=>{d(),R()},[i,d]);const R=async()=>{try{const{data:s,error:r}=await n.from("product_categories").select("*").order("name");if(r)throw r;T(s||[])}catch(s){console.error("Error fetching categories:",s),o(s.message)}},S=async s=>{try{const{data:r,error:t}=await n.from("product_arrangements").select("*").eq("product_id",s).order("display_order");if(t)throw t;M(r||[])}catch(r){console.error("Error fetching arrangements:",r),o(r.message)}},B=async(s,r)=>{if(h)try{const{error:t}=await n.from("product_arrangements").upsert({id:N||void 0,product_id:s,category_id:h,store_id:r,display_order:l.display_order,is_visible:l.is_visible,starts_at:l.starts_at||null,ends_at:l.ends_at||null});if(t)throw t;await S(s),_(null),f(""),c({display_order:0,is_visible:!0,starts_at:"",ends_at:""})}catch(t){console.error("Error saving arrangement:",t),o(t.message)}},F=async(s,r)=>{try{const{error:t}=await n.from("product_arrangements").delete().eq("id",s);if(t)throw t;await S(r)}catch(t){console.error("Error removing arrangement:",t),o(t.message)}},U=async s=>{if(window.confirm("Are you sure you want to delete this product?"))try{const{error:r}=await n.from("products").delete().eq("id",s);if(r)throw r;x(u.filter(t=>t.id!==s)),d(),o(null)}catch(r){console.error("Error deleting product:",r),o(r.message)}},$=async s=>{try{const{error:r}=await n.from("products").update({in_stock:!s.in_stock,stock_quantity:s.in_stock?0:1,updated_at:new Date().toISOString()}).eq("id",s.id);if(r)throw r;x(u.map(t=>t.id===s.id?{...t,in_stock:!t.in_stock,stock_quantity:t.in_stock?0:1,updated_at:new Date().toISOString()}:t)),d(),o(null)}catch(r){console.error("Error updating product status:",r),o(r.message)}},C=u.filter(s=>{var r;return s.name.toLowerCase().includes(m.toLowerCase())||s.category.toLowerCase().includes(m.toLowerCase())||((r=s.description)==null?void 0:r.toLowerCase().includes(m.toLowerCase()))});return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"sm:flex sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Products"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"Manage products for your stores"})]}),e.jsx("div",{className:"mt-4 sm:mt-0",children:e.jsx(P,{to:"/store-manager/products/new",children:e.jsxs(p,{variant:"primary",className:"bg-green-600 hover:bg-green-700",children:[e.jsx(z,{className:"h-4 w-4 mr-1"}),"Add Product"]})})})]}),b&&e.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded relative",children:b}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsx("select",{value:i,onChange:s=>v(s.target.value),className:"block w-full sm:w-48 pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm rounded-md",children:O.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))}),e.jsxs("div",{className:"relative rounded-md flex-grow",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(G,{className:"h-5 w-5 text-gray-400","aria-hidden":"true"})}),e.jsx("input",{type:"text",placeholder:"Search products...",className:"block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-green-500 focus:border-green-500 sm:text-sm",value:m,onChange:s=>L(s.target.value)})]}),e.jsxs(p,{variant:"secondary",onClick:d,children:[" ",e.jsx(H,{className:"h-4 w-4 mr-1"}),"Refresh"]})]}),q?e.jsxs("div",{className:"p-6 text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-green-500 mx-auto"}),e.jsx("p",{className:"mt-4 text-gray-500",children:"Loading products..."})]}):C.length>0?e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6",children:C.map(s=>e.jsxs("div",{className:"bg-white shadow-md rounded-lg overflow-hidden hover:shadow-lg transition-shadow duration-200",children:[e.jsxs("div",{className:"relative h-48 bg-gray-200",children:[s.image_url?e.jsx("img",{src:s.image_url,alt:s.name,className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-gray-100",children:e.jsx("span",{className:"text-gray-400",children:"No image"})}),e.jsx("div",{className:"absolute top-2 right-2",children:e.jsxs("div",{className:"flex space-x-1",children:[e.jsx(P,{to:`/store-manager/products/${s.id}/edit`,className:"p-1 bg-white rounded-full shadow hover:bg-gray-100",children:e.jsx(E,{className:"h-4 w-4 text-green-600"})}),e.jsx("button",{onClick:()=>U(s.id),className:"p-1 bg-white rounded-full shadow hover:bg-gray-100",children:e.jsx(A,{className:"h-4 w-4 text-red-600"})})]})}),!s.in_stock&&e.jsx("div",{className:"absolute top-2 left-2",children:e.jsx("span",{className:"px-2 py-1 bg-red-500 text-white text-xs font-bold rounded",children:"Out of Stock"})})]}),e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 truncate",children:s.name}),e.jsx("p",{className:"text-sm text-gray-600 mt-1 line-clamp-2",children:s.description})]}),e.jsx(J,{amount:s.price})]}),e.jsxs("div",{className:"mt-3 flex justify-between items-center",children:[e.jsx("span",{className:"px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded",children:s.category}),e.jsx("button",{onClick:()=>$(s),className:`text-sm ${s.in_stock?"text-green-600 hover:text-green-700":"text-red-600 hover:text-red-700"}`,children:s.in_stock?"In Stock":"Out of Stock"})]}),e.jsxs("div",{className:"mt-2 text-sm text-gray-500",children:["Store: ",s.stores.name]}),e.jsxs("div",{className:"mt-4 border-t pt-4",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-700 mb-2",children:"Product Arrangements"}),e.jsx("div",{className:"space-y-2 mb-4",children:I.filter(r=>r.product_id===s.id).map(r=>{const t=w.find(g=>g.id===r.category_id);return e.jsxs("div",{className:"flex items-center justify-between bg-gray-50 p-2 rounded",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:t==null?void 0:t.name}),e.jsxs("span",{className:"text-sm text-gray-500 ml-2",children:["Order: ",r.display_order]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("button",{onClick:()=>{_(r.id),f(r.category_id),c({display_order:r.display_order,is_visible:r.is_visible,starts_at:r.starts_at||"",ends_at:r.ends_at||""})},className:"text-green-600 hover:text-green-800",children:e.jsx(E,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>F(r.id,s.id),className:"text-red-600 hover:text-red-800",children:e.jsx(A,{className:"h-4 w-4"})})]})]},r.id)})}),e.jsxs("div",{className:"space-y-3 bg-gray-50 p-3 rounded",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Category"}),e.jsxs("select",{value:h,onChange:r=>f(r.target.value),className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm",children:[e.jsx("option",{value:"",children:"Select a category"}),w.map(r=>e.jsx("option",{value:r.id,children:r.name},r.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Display Order"}),e.jsx("input",{type:"number",value:l.display_order,onChange:r=>c(t=>({...t,display_order:parseInt(r.target.value)})),className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm"})]}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",checked:l.is_visible,onChange:r=>c(t=>({...t,is_visible:r.target.checked})),className:"h-4 w-4 text-green-600 border-gray-300 rounded"}),e.jsx("span",{className:"ml-2 text-sm text-gray-900",children:"Is Visible"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Starts At"}),e.jsx("input",{type:"datetime-local",value:l.starts_at,onChange:r=>c(t=>({...t,starts_at:r.target.value})),className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Ends At"}),e.jsx("input",{type:"datetime-local",value:l.ends_at,onChange:r=>c(t=>({...t,ends_at:r.target.value})),className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm"})]}),e.jsx(p,{onClick:()=>B(s.id,s.stores.id),variant:"secondary",className:"w-full",children:N?"Update Arrangement":"Add Arrangement"})]})]})]})]},s.id))}):e.jsx("div",{className:"p-6 text-center text-gray-500",children:"No products found for the selected store."})]})};export{Z as default};
