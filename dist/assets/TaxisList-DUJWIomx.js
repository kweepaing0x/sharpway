import{s as o,j as e,B as x,a1 as D,m as q,S as O,a2 as z,a4 as J,T as M}from"./ui-components-CL-10tNC.js";import{r as n,L as h}from"./react-vendor-NfsKhbMh.js";import"./supabase-DQ7Oc2S5.js";const P=()=>{const[_,c]=n.useState([]),[p,g]=n.useState(!0),[m,C]=n.useState(""),[f,l]=n.useState(null),[y,S]=n.useState(0),[w,j]=n.useState(null),[T,v]=n.useState(null),[u,N]=n.useState(null),d=n.useCallback(async()=>{try{g(!0);const{data:s,error:r}=await o.from("taxis").select("*").order("display_order",{ascending:!0,nullsLast:!0}).order("driver_name");if(r)throw r;c(s||[]);const{count:a,error:i}=await o.from("taxis").select("*",{count:"exact"}).eq("approval_status","pending");if(i)throw i;S(a||0),l(null)}catch(s){console.error("Error fetching taxis:",s),l(s.message)}finally{g(!1)}},[]),I=async(s,r)=>{v(s);try{const{error:a}=await o.from("taxis").update({display_order:r}).eq("id",s);if(a)throw a;c(i=>i.map(t=>t.id===s?{...t,display_order:r}:t)),l(null)}catch(a){console.error("Error updating display order:",a),l(a.message),await d()}finally{v(null)}};n.useEffect(()=>{d()},[d]);const k=async s=>{try{const{data:r,error:a}=await o.from("taxi_managers").select("id, user_id").eq("taxi_id",s);if(a)throw a;for(const i of r||[]){const t=await fetch("https://omzqjvehfhjtfrphzuax.supabase.co/functions/v1/delete-taxi-manager",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9tenFqdmVoZmhqdGZycGh6dWF4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NzAzMDIsImV4cCI6MjA2NjM0NjMwMn0.JLHxw99HYn0z2S0uWt6shQGlqTeQNKNagoAlbNCb0nQ"},body:JSON.stringify({userId:i.user_id,managerId:i.id})});if(!t.ok){const A=await t.json();console.error("Error deleting manager:",A)}}return!0}catch(r){return console.error("Error deleting taxi managers:",r),!1}},L=async s=>{if(window.confirm("Are you sure you want to delete this taxi? This will also delete all associated taxi managers.")){j(s),l(null);try{await k(s)||console.warn("Some managers may not have been deleted properly");const{error:a}=await o.from("taxis").delete().eq("id",s);if(a)throw a;c(i=>i.filter(t=>t.id!==s)),l(null)}catch(r){console.error("Error deleting taxi:",r),l(`Failed to delete taxi: ${r.message}. If this problem persists, please contact support.`),await d()}finally{j(null)}}},E=async s=>{N(s.id),l(null);try{const r=!s.is_active,{error:a}=await o.from("taxis").update({is_active:r}).eq("id",s.id);if(a)throw a;c(i=>i.map(t=>t.id===s.id?{...t,is_active:r}:t)),l(null)}catch(r){console.error("Error updating taxi status:",r),l(r.message),await d()}finally{N(null)}},b=_.filter(s=>s.driver_name.toLowerCase().includes(m.toLowerCase())||s.vehicle_type.toLowerCase().includes(m.toLowerCase())||s.location.toLowerCase().includes(m.toLowerCase()));return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"sm:flex sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Taxis"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"Manage all taxi drivers in your system"})]}),e.jsxs("div",{className:"mt-4 sm:mt-0 space-y-2 sm:space-y-0 sm:space-x-2",children:[y>0&&e.jsx(h,{to:"/admin/taxis/approval",children:e.jsxs(x,{variant:"secondary",className:"w-full sm:w-auto",children:[e.jsx(D,{className:"h-4 w-4 mr-1 text-yellow-500"}),"Review Pending (",y,")"]})}),e.jsx(h,{to:"/admin/taxis/new",children:e.jsxs(x,{variant:"primary",className:"w-full sm:w-auto",children:[e.jsx(q,{className:"h-4 w-4 mr-1"}),"Add Taxi Driver"]})})]})]}),f&&e.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded relative",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:f}),e.jsx("button",{onClick:()=>l(null),className:"text-red-700 hover:text-red-900",children:"Ã—"})]})}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("div",{className:"relative rounded-md flex-grow",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(O,{className:"h-5 w-5 text-gray-400","aria-hidden":"true"})}),e.jsx("input",{type:"text",placeholder:"Search taxis...",className:"block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm",value:m,onChange:s=>C(s.target.value)})]}),e.jsxs(x,{variant:"secondary",children:[e.jsx(z,{className:"h-4 w-4 mr-1"}),"Filter"]}),e.jsx(x,{variant:"secondary",onClick:d,disabled:p,children:p?"Refreshing...":"Refresh"})]}),e.jsx("div",{className:"bg-white shadow-md overflow-hidden sm:rounded-md",children:p?e.jsxs("div",{className:"p-6 text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"}),e.jsx("p",{className:"mt-4 text-gray-500",children:"Loading taxis..."})]}):b.length>0?e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Driver"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Display Order"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Vehicle Type"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Location"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Status"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:b.map(s=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"flex-shrink-0 h-10 w-10",children:s.photo_url?e.jsx("img",{className:"h-10 w-10 rounded-full object-cover",src:s.photo_url,alt:s.driver_name}):e.jsx("div",{className:"h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center",children:e.jsx("span",{className:"text-blue-600 font-medium",children:s.driver_name.substring(0,2).toUpperCase()})})}),e.jsxs("div",{className:"ml-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:s.driver_name}),e.jsx("div",{className:"text-sm text-gray-500 truncate max-w-xs",children:s.description})]})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"number",min:"1",max:"999",value:s.display_order||"",onChange:r=>I(s.id,parseInt(r.target.value)||null),className:"w-16 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500",placeholder:"Order",disabled:T===s.id}),s.display_order&&s.display_order<=10&&e.jsx("span",{className:"text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full",children:"Featured"})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:"px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800",children:s.vehicle_type==="motorcycle"?"Motorcycle":"Car"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:s.location}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("button",{onClick:()=>E(s),disabled:u===s.id,className:`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${u===s.id?"bg-gray-100 text-gray-500 cursor-not-allowed":s.is_active?"bg-green-100 text-green-800 hover:bg-green-200":"bg-red-100 text-red-800 hover:bg-red-200"}`,children:u===s.id?e.jsxs("span",{className:"flex items-center",children:[e.jsx("div",{className:"animate-spin h-3 w-3 border-b-2 border-gray-500 rounded-full mr-1"}),"Updating..."]}):s.is_active?"Active":"Inactive"}),e.jsx("span",{className:`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${s.approval_status==="approved"?"bg-green-100 text-green-800":s.approval_status==="pending"?"bg-yellow-100 text-yellow-800":"bg-red-100 text-red-800"}`,children:s.approval_status.charAt(0).toUpperCase()+s.approval_status.slice(1)})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium",children:e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(h,{to:`/admin/taxis/${s.id}/edit`,className:"text-indigo-600 hover:text-indigo-900",title:"Edit",children:e.jsx(J,{className:"h-5 w-5"})}),e.jsx("button",{onClick:()=>L(s.id),className:"text-red-600 hover:text-red-900",title:"Delete",disabled:w===s.id,children:w===s.id?e.jsx("div",{className:"animate-spin h-5 w-5 border-b-2 border-red-500 rounded-full"}):e.jsx(M,{className:"h-5 w-5"})})]})})]},s.id))})]})}):e.jsx("div",{className:"p-6 text-center text-gray-500",children:"No taxis found matching your search criteria."})})]})};export{P as default};
