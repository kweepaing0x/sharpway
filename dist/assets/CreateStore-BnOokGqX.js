import{s as y,j as e,B as E,A as re,u as se,x as te,y as ne,v as oe,D as c,a5 as le,a6 as ie}from"./ui-components-CL-10tNC.js";import{u as ce,r as m}from"./react-vendor-NfsKhbMh.js";import{c as me,T as C,d as R}from"./stores-BBDuH2RS.js";import{a as de}from"./index-DNL726t5.js";import"./supabase-DQ7Oc2S5.js";const ue=["Fashion","Electronics","Food & Beverage","Home & Living","Health & Beauty","Sports & Leisure","Books & Stationery","Services","Other"],H=[{value:0,label:"Sunday"},{value:1,label:"Monday"},{value:2,label:"Tuesday"},{value:3,label:"Wednesday"},{value:4,label:"Thursday"},{value:5,label:"Friday"},{value:6,label:"Saturday"}],he=H.map(h=>({day_of_week:h.value,opens_at:"10:00",closes_at:"22:00",is_closed:!1})),be=()=>{const h=ce(),[P,U]=m.useState(!1),[A,f]=m.useState(null),[k,z]=m.useState(!0),[M,I]=m.useState(!1),[g,B]=m.useState(he),{adminTimeZone:v}=me(),b=m.useRef(null),{isSuperAdmin:N}=de(),[q,J]=m.useState([]),[Z,W]=m.useState(!1),[s,j]=m.useState({name:"",description:"",logo_url:"",location:"",category:"",telegram_bot_token:"",telegram_chat_id:"",username:"",payment_methods:{kpay:!1,usdt:!1,cod:!1,wallet_addresses:{}},phone_number:"",channel_link:""}),[d,S]=m.useState({create_manager:!1,manager_email:"",manager_password:""}),[p,K]=m.useState({kpay:"",usdt:""});m.useEffect(()=>(N&&S(r=>({...r,create_manager:!0})),Y(),G(),()=>{b.current&&clearTimeout(b.current)}),[N]);const G=async()=>{W(!0);try{const{data:r,error:a}=await y.from("store_categories").select("*").eq("is_active",!0).order("name");if(a)throw a;J(r||[])}catch(r){console.error("Error fetching store categories:",r)}finally{W(!1)}},Y=async()=>{const{data:{user:r},error:a}=await y.auth.getUser();(a||!r)&&h("/admin/login",{replace:!0})},$=r=>r.toLowerCase().replace(/[^a-z0-9]/g,"").replace(/\s+/g,""),D=async r=>{if(!r)return!0;I(!0);try{const{data:a,error:t}=await y.from("stores").select("username").eq("username",r).maybeSingle(),n=!a;return z(n),t&&t.code!=="PGRST116"?(console.error("Error checking username:",t),!0):n}catch(a){return console.error("Error checking username:",a),!0}finally{I(!1)}},L=r=>{b.current&&clearTimeout(b.current),b.current=setTimeout(()=>{D(r)},300)},l=r=>{const{name:a,value:t,type:n}=r.target;if(n==="checkbox"){const o=r.target;a==="create_manager"?S(i=>({...i,[a]:o.checked})):j(i=>({...i,payment_methods:{...i.payment_methods,[a]:o.checked}}))}else if(a.startsWith("manager_"))S(o=>({...o,[a]:t}));else{if(j(o=>({...o,[a]:t})),a==="name"){const o=$(t);j(i=>({...i,username:o})),L(o)}a==="username"&&L(t)}},Q=r=>{j(a=>({...a,logo_url:r}))},F=r=>{const{name:a,value:t}=r.target;K(n=>({...n,[a]:t}))},T=(r,a,t)=>{B(n=>n.map((o,i)=>i===r?{...o,[a]:t}:o))},V=r=>{for(const a of r)if(!a.is_closed&&(!a.opens_at||!a.closes_at))return"Opening and closing times are required for open days";return null},X=()=>{if(!s.name.trim())return"Store name is required";if(!s.username.trim())return"Username is required";if(!k)return"Username is not available, please choose another one";if(M)return"Please wait while we check username availability";if(!s.category)return"Category is required";if(!s.location.trim())return"Location is required";if(s.payment_methods.kpay&&!p.kpay)return"KPay wallet address is required when KPay is enabled";if(s.payment_methods.usdt&&!p.usdt)return"USDT wallet address is required when USDT is enabled";if(d.create_manager){if(!d.manager_email)return"Manager email is required";if(!d.manager_password)return"Manager password is required";if(d.manager_password.length<6)return"Manager password must be at least 6 characters"}return V(g)},ee=async r=>{try{const a="https://omzqjvehfhjtfrphzuax.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9tenFqdmVoZmhqdGZycGh6dWF4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NzAzMDIsImV4cCI6MjA2NjM0NjMwMn0.JLHxw99HYn0z2S0uWt6shQGlqTeQNKNagoAlbNCb0nQ",n=`${a}/functions/v1/create-manager`,o={"Content-Type":"application/json",Authorization:`Bearer ${t}`},i=JSON.stringify({email:d.manager_email,password:d.manager_password,store_id:r});console.log("Attempting to call create-manager edge function:"),console.log("URL:",n),console.log("Headers:",o),console.log("Body:",i);const u=await fetch(n,{method:"POST",headers:o,body:i});if(console.log("Response status:",u.status),!u.ok){const x=await u.text();console.error("Raw error response from edge function:",x);try{const w=JSON.parse(x);throw new Error(w.error||`Failed to create manager: ${u.statusText}`)}catch{throw new Error(`Failed to create manager: ${u.statusText}. Raw response: ${x}`)}}return await u.json()}catch(a){throw console.error("Error in createStoreManager:",a),a}},ae=async r=>{r.preventDefault(),f(null);const a=X();if(a){f(a);return}if(!await D(s.username)){f("Username is not available. Please choose a different one.");return}U(!0);try{const{data:{user:n},error:o}=await y.auth.getUser();if(o)throw new Error("Authentication error");if(!n){h("/admin/login",{replace:!0});return}const i={...s.payment_methods,wallet_addresses:{kpay:s.payment_methods.kpay?p.kpay:"",usdt:s.payment_methods.usdt?p.usdt:""}},{data:u,error:x}=await y.from("stores").insert([{...s,payment_methods:i,owner_id:n.id,is_active:!0,approval_status:"approved"}]).select().single();if(x)throw x;const w=g.map(_=>({..._,opens_at:v===C.MMT?_.opens_at:R(_.opens_at,v,C.MMT),closes_at:v===C.MMT?_.closes_at:R(_.closes_at,v,C.MMT),store_id:u.id})),{error:O}=await y.from("store_hours").insert(w);if(O)throw O;d.create_manager&&await ee(u.id),h("/admin/stores")}catch(n){console.error("Error creating store:",n),f(n.message)}finally{U(!1)}};return e.jsxs("div",{className:"max-w-2xl mx-auto py-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs(E,{variant:"ghost",onClick:()=>h("/admin/stores"),className:"mb-4",children:[e.jsx(re,{className:"h-4 w-4 mr-2"}),"Back to Stores"]}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Create New Store"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"Add a new store to your mall"})]}),e.jsx(se,{children:e.jsxs("form",{onSubmit:ae,children:[e.jsx(te,{children:e.jsx(ne,{children:"Store Information"})}),e.jsxs(oe,{className:"space-y-4",children:[A&&e.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded relative",children:A}),e.jsxs("div",{className:"grid grid-cols-1 gap-4",children:[e.jsx(c,{label:"Store Name",name:"name",value:s.name,onChange:l,required:!0,fullWidth:!0}),e.jsxs("div",{className:"relative",children:[e.jsx(c,{label:"Username",name:"username",value:s.username,onChange:l,required:!0,fullWidth:!0,helperText:M?"Checking availability...":s.username?k?"Username is available":"Username is not available":"Username will be used in your store URL",error:s.username&&!k?"This username is already taken":void 0}),s.username&&e.jsxs("p",{className:"mt-1 text-sm text-gray-500",children:["Your store URL will be: /@",s.username]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Store Logo"}),e.jsx(le,{value:s.logo_url,onChange:Q,onError:f,bucket:"mall-images",folder:"stores"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Category"}),e.jsxs("select",{name:"category",value:s.category,onChange:l,className:"mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md",required:!0,children:[e.jsx("option",{value:"",children:"Select a category"}),Z?e.jsx("option",{value:"",disabled:!0,children:"Loading categories..."}):q.length>0?q.map(r=>e.jsx("option",{value:r.id,children:r.name},r.id)):ue.map(r=>e.jsx("option",{value:r,children:r},r))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Description"}),e.jsx("textarea",{name:"description",value:s.description,onChange:l,rows:3,className:"w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(c,{label:"Location",name:"location",value:s.location,onChange:l,required:!0,fullWidth:!0}),e.jsx(c,{label:"Phone Number",name:"phone_number",value:s.phone_number,onChange:l,fullWidth:!0})]}),e.jsx(c,{label:"Telegram Channel Link",name:"channel_link",value:s.channel_link,onChange:l,fullWidth:!0,placeholder:"e.g., https://t.me/yourchannel"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(c,{label:"Telegram Bot Token",name:"telegram_bot_token",value:s.telegram_bot_token,onChange:l,fullWidth:!0}),e.jsx(c,{label:"Telegram Chat ID",name:"telegram_chat_id",value:s.telegram_chat_id,onChange:l,fullWidth:!0})]}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mt-6",children:"Payment Methods"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",name:"kpay",checked:s.payment_methods.kpay,onChange:l,className:"h-4 w-4 text-blue-600 border-gray-300 rounded"}),e.jsx("span",{className:"ml-2 text-sm text-gray-900",children:"KPay"})]}),s.payment_methods.kpay&&e.jsx(c,{label:"KPay Wallet Address",name:"kpay",value:p.kpay,onChange:F,fullWidth:!0,required:!0}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",name:"usdt",checked:s.payment_methods.usdt,onChange:l,className:"h-4 w-4 text-blue-600 border-gray-300 rounded"}),e.jsx("span",{className:"ml-2 text-sm text-gray-900",children:"USDT"})]}),s.payment_methods.usdt&&e.jsx(c,{label:"USDT Wallet Address",name:"usdt",value:p.usdt,onChange:F,fullWidth:!0,required:!0}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",name:"cod",checked:s.payment_methods.cod,onChange:l,className:"h-4 w-4 text-blue-600 border-gray-300 rounded"}),e.jsx("span",{className:"ml-2 text-sm text-gray-900",children:"Cash on Delivery (COD)"})]})]}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mt-6",children:"Working Hours"}),e.jsx("div",{className:"space-y-4",children:H.map((r,a)=>e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"w-24 text-sm font-medium text-gray-700",children:r.label}),e.jsx("input",{type:"checkbox",checked:g[a].is_closed,onChange:t=>T(a,"is_closed",t.target.checked),className:"h-4 w-4 text-blue-600 border-gray-300 rounded"}),e.jsx("span",{className:"text-sm text-gray-900",children:"Closed"}),!g[a].is_closed&&e.jsxs(e.Fragment,{children:[e.jsx(c,{type:"time",value:g[a].opens_at,onChange:t=>T(a,"opens_at",t.target.value),className:"w-32"}),e.jsx("span",{className:"text-sm text-gray-500",children:"to"}),e.jsx(c,{type:"time",value:g[a].closes_at,onChange:t=>T(a,"closes_at",t.target.value),className:"w-32"})]})]},r.value))}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mt-6",children:"Manager Account"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",name:"create_manager",checked:d.create_manager,onChange:l,className:"h-4 w-4 text-blue-600 border-gray-300 rounded",disabled:N}),e.jsx("span",{className:"ml-2 text-sm text-gray-900",children:"Create Manager Account"})]}),d.create_manager&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mt-2",children:[e.jsx(c,{label:"Manager Email",name:"manager_email",type:"email",value:d.manager_email,onChange:l,required:!0,fullWidth:!0}),e.jsx(c,{label:"Manager Password",name:"manager_password",type:"password",value:d.manager_password,onChange:l,required:!0,fullWidth:!0})]})]})]}),e.jsxs(ie,{className:"flex justify-end space-x-2",children:[e.jsx(E,{type:"button",variant:"secondary",onClick:()=>h("/admin/stores"),children:"Cancel"}),e.jsx(E,{type:"submit",variant:"primary",isLoading:P,className:"bg-blue-600 hover:bg-blue-700",children:"Create Store"})]})]})})]})};export{be as default};
