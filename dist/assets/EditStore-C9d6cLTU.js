import{s as h,j as e,B as f,A as se,u as ae,x as L,y as F,v as H,D as g,a5 as re,a6 as te,o as oe}from"./ui-components-CL-10tNC.js";import{u as ne,f as le,r as l}from"./react-vendor-NfsKhbMh.js";import{c as ie,T as m,d as w}from"./stores-BBDuH2RS.js";import"./supabase-DQ7Oc2S5.js";const D=[{value:0,label:"Sunday"},{value:1,label:"Monday"},{value:2,label:"Tuesday"},{value:3,label:"Wednesday"},{value:4,label:"Thursday"},{value:5,label:"Friday"},{value:6,label:"Saturday"}],de=D.map(x=>({day_of_week:x.value,opens_at:"10:00",closes_at:"22:00",is_closed:!1})),ce=["Fashion","Electronics","Food & Beverage","Home & Living","Health & Beauty","Sports & Leisure","Books & Stationery","Services","Other"],pe=()=>{const x=ne(),{id:u}=le(),[T,b]=l.useState(!1),[_,d]=l.useState(null),[N,v]=l.useState(null),[k,M]=l.useState(de),[C,O]=l.useState(!0),[R,E]=l.useState(!1),[I,q]=l.useState(!1),{adminTimeZone:i}=ie(),[U,P]=l.useState([]),[z,W]=l.useState(!1),B=async()=>{if(window.confirm("Are you sure you want to reset the store manager password? This will generate a new temporary password.")){q(!0),d(null),v(null);try{const s=await fetch("https://omzqjvehfhjtfrphzuax.supabase.co/functions/v1/reset-manager-password",{method:"POST",headers:{Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9tenFqdmVoZmhqdGZycGh6dWF4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NzAzMDIsImV4cCI6MjA2NjM0NjMwMn0.JLHxw99HYn0z2S0uWt6shQGlqTeQNKNagoAlbNCb0nQ","Content-Type":"application/json"},body:JSON.stringify({storeId:u})}),a=await s.json();if(!s.ok)throw new Error(a.error||"Failed to reset password");v("Manager password has been reset successfully. The new temporary password has been sent to the manager.")}catch(s){console.error("Error resetting manager password:",s),d(`Failed to reset manager password: ${s.message}`)}finally{q(!1)}}},[o,j]=l.useState({name:"",description:"",logo_url:"",location:"",category:"",telegram_bot_token:"",telegram_chat_id:"",username:"",payment_methods:{kpay:!1,usdt:!1,cod:!1,wallet_addresses:{}},phone_number:"",channel_link:""}),[y,A]=l.useState({kpay:"",usdt:""});l.useEffect(()=>{Y(),Z(),J()},[u]);const J=async()=>{W(!0);try{const{data:s,error:a}=await h.from("store_categories").select("*").eq("is_active",!0).order("name");if(a)throw a;P(s||[])}catch(s){console.error("Error fetching store categories:",s)}finally{W(!1)}},Z=async()=>{try{const{data:s,error:a}=await h.from("store_hours").select("*").eq("store_id",u).order("day_of_week");if(a)throw a;if(s&&s.length>0){const r=s.map(t=>({...t,opens_at:i===m.MMT?t.opens_at:w(t.opens_at,m.MMT,i),closes_at:i===m.MMT?t.closes_at:w(t.closes_at,m.MMT,i)}));M(r)}}catch(s){console.error("Error fetching working hours:",s)}},G=async(s,a)=>{if(s){E(!0);try{const{data:r,error:t}=await h.from("stores").select("username").eq("username",s).neq("id",a).single();if(O(!r),t&&t.code!=="PGRST116")throw t}catch(r){console.error("Error checking username:",r)}finally{E(!1)}}},S=(s,a,r)=>{M(t=>t.map((n,p)=>p===s?{...n,[a]:r}:n))},K=s=>{for(const a of s)if(!a.is_closed&&(!a.opens_at||!a.closes_at))return"Opening and closing times are required for open days";return null},Y=async()=>{var s,a;try{const{data:{user:r},error:t}=await h.auth.getUser();if(t)throw t;const{data:n,error:p}=await h.from("stores").select("*").eq("id",u).single();if(p)throw p;if(!n)throw new Error("Store not found");if(n.owner_id!==(r==null?void 0:r.id))throw new Error("Unauthorized");j({name:n.name,description:n.description||"",logo_url:n.logo_url||"",location:n.location,category:n.category,telegram_bot_token:n.telegram_bot_token||"",telegram_chat_id:n.telegram_chat_id||"",username:n.username||"",payment_methods:{kpay:n.payment_methods.kpay||!1,usdt:n.payment_methods.usdt||!1,cod:n.payment_methods.cod||!1,wallet_addresses:n.payment_methods.wallet_addresses||{}},phone_number:n.phone_number||"",channel_link:n.channel_link||""}),A({kpay:((s=n.payment_methods.wallet_addresses)==null?void 0:s.kpay)||"",usdt:((a=n.payment_methods.wallet_addresses)==null?void 0:a.usdt)||""})}catch(r){console.error("Error fetching store:",r),d(r.message),x("/admin/stores")}},c=s=>{const{name:a,value:r,type:t}=s.target;if(t==="checkbox"){const n=s.target;j(p=>({...p,payment_methods:{...p.payment_methods,[a]:n.checked}}))}else j(n=>({...n,[a]:r})),a==="username"&&G(r,u||"")},Q=s=>{j(a=>({...a,logo_url:s}))},$=s=>{const{name:a,value:r}=s.target;A(t=>({...t,[a]:r}))},V=async()=>{const s=K(k);if(s){d(s);return}b(!0),d(null),v(null);try{await h.from("store_hours").delete().eq("store_id",u);const a=k.map(t=>({...t,opens_at:i===m.MMT?t.opens_at:w(t.opens_at,i,m.MMT),closes_at:i===m.MMT?t.closes_at:w(t.closes_at,i,m.MMT),store_id:u})),{error:r}=await h.from("store_hours").insert(a);if(r)throw r;v("Working hours updated successfully")}catch(a){console.error("Error saving working hours:",a),d("Failed to update working hours")}finally{b(!1)}},X=()=>o.name.trim()?o.username.trim()?C?o.category?o.location.trim()?o.payment_methods.kpay&&!y.kpay?"KPay wallet address is required when KPay is enabled":o.payment_methods.usdt&&!y.usdt?"USDT wallet address is required when USDT is enabled":null:"Location is required":"Category is required":"Username is not available":"Username is required":"Store name is required",ee=async s=>{s.preventDefault();const a=X();if(a){d(a);return}b(!0),d(null);try{const r={...o.payment_methods,wallet_addresses:{kpay:o.payment_methods.kpay?y.kpay:"",usdt:o.payment_methods.usdt?y.usdt:""}},{error:t}=await h.from("stores").update({...o,payment_methods:r,updated_at:new Date().toISOString()}).eq("id",u);if(t)throw t;x("/admin/stores")}catch(r){console.error("Error updating store:",r),d(r.message)}finally{b(!1)}};return e.jsxs("div",{className:"max-w-2xl mx-auto py-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs(f,{variant:"ghost",onClick:()=>x("/admin/stores"),className:"mb-4",children:[e.jsx(se,{className:"h-4 w-4 mr-2"}),"Back to Stores"]}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Edit Store"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"Update your store information"})]}),e.jsxs(ae,{children:[e.jsxs("form",{onSubmit:ee,children:[e.jsx(L,{children:e.jsx(F,{children:"Store Information"})}),e.jsxs(H,{className:"space-y-4",children:[_&&e.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded relative",children:_}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2",children:[e.jsx(g,{label:"Store Name",name:"name",value:o.name,onChange:c,required:!0,fullWidth:!0}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Category"}),e.jsxs("select",{name:"category",value:o.category,onChange:c,className:"mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md",required:!0,children:[e.jsx("option",{value:"",children:"Select a category"}),z?e.jsx("option",{value:"",disabled:!0,children:"Loading categories..."}):U.length>0?U.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id)):ce.map(s=>e.jsx("option",{value:s,children:s},s))]})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(g,{label:"Username",name:"username",value:o.username,onChange:c,required:!0,fullWidth:!0,helperText:R?"Checking availability...":o.username?C?"Username is available":"Username is not available":"Username will be used in your store URL",error:o.username&&!C?"This username is already taken":void 0}),o.username&&e.jsxs("p",{className:"mt-1 text-sm text-gray-500",children:["Your store URL will be: /@",o.username]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Description"}),e.jsx("textarea",{name:"description",value:o.description,onChange:c,rows:3,className:"w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Store Logo"}),e.jsx(re,{value:o.logo_url,onChange:Q,onError:d,bucket:"mall-images",folder:"stores"})]}),e.jsx("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2",children:e.jsx(g,{label:"Location",name:"location",value:o.location,onChange:c,required:!0,fullWidth:!0})}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2",children:[e.jsx(g,{label:"Phone Number",name:"phone_number",value:o.phone_number,onChange:c,fullWidth:!0,helperText:"Optional"}),e.jsx(g,{label:"Channel Link",name:"channel_link",value:o.channel_link,onChange:c,fullWidth:!0,helperText:"Optional - Social media or channel URL"})]}),e.jsxs("div",{className:"border-t border-gray-200 pt-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"Store Manager Password Reset"}),e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4",children:e.jsx("p",{className:"text-sm text-yellow-800",children:"Use this feature to reset the store manager's password. A new temporary password will be generated and sent to the manager."})}),e.jsx(f,{type:"button",variant:"secondary",onClick:B,disabled:I,className:"bg-yellow-600 hover:bg-yellow-700 text-white",children:I?"Resetting...":"Reset Manager Password"})]}),e.jsxs("div",{className:"border-t border-gray-200 pt-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"Telegram Integration"}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2",children:[e.jsx(g,{label:"Telegram Bot Token",name:"telegram_bot_token",value:o.telegram_bot_token,onChange:c,fullWidth:!0}),e.jsx(g,{label:"Telegram Chat ID",name:"telegram_chat_id",value:o.telegram_chat_id,onChange:c,fullWidth:!0})]})]}),e.jsxs("div",{className:"border-t border-gray-200 pt-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"Payment Methods"}),e.jsx("div",{className:"space-y-4",children:e.jsx("div",{className:"space-y-2",children:[{key:"kpay",label:"KPay"},{key:"usdt",label:"USDT"},{key:"cod",label:"Cash on Delivery"}].map(({key:s,label:a})=>e.jsxs("div",{children:[e.jsxs("label",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",name:s,checked:o.payment_methods[s],onChange:c,className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),e.jsx("span",{className:"text-sm text-gray-700",children:a})]}),(s==="kpay"||s==="usdt")&&o.payment_methods[s]&&e.jsx(g,{name:s,value:y[s],onChange:$,placeholder:`Enter ${a} wallet address`,className:"mt-2",required:!0,fullWidth:!0})]},s))})})]})]}),e.jsxs(te,{className:"flex justify-end space-x-2",children:[e.jsx(f,{type:"button",variant:"secondary",onClick:()=>x("/admin/stores"),children:"Cancel"}),e.jsx(f,{type:"submit",variant:"primary",isLoading:T,children:"Save Changes"})]})]}),e.jsx(L,{className:"border-t",children:e.jsxs(F,{className:"flex items-center",children:[e.jsx(oe,{className:"h-5 w-5 mr-2"}),"Working Hours (Myanmar Time)",i!==m.MMT&&e.jsxs("span",{className:"ml-2 text-sm font-normal text-gray-500",children:["Displayed in ",i===m.ICT?"Thailand Time":i]})]})}),e.jsxs(H,{children:[_&&!N&&e.jsx("div",{className:"mb-4 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded relative",children:_}),N&&e.jsx("div",{className:"mb-4 bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded relative",children:N}),e.jsx("div",{className:"bg-blue-50 p-4 mb-6 rounded-md",children:e.jsxs("p",{className:"text-sm text-blue-700",children:[e.jsx("strong",{children:"Note:"})," All working hours are stored in Myanmar Time (MMT), but displayed in your selected admin time zone. When you save changes, they'll be automatically converted back to Myanmar Time."]})}),e.jsx("div",{className:"space-y-4",children:k.map((s,a)=>e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"w-32",children:e.jsx("span",{className:"font-medium",children:D[s.day_of_week].label})}),e.jsxs("label",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",checked:s.is_closed,onChange:r=>S(a,"is_closed",r.target.checked),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),e.jsx("span",{className:"text-sm text-gray-600",children:"Closed"})]}),!s.is_closed&&e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"time",value:s.opens_at,onChange:r=>S(a,"opens_at",r.target.value),className:"px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0}),e.jsx("span",{className:"text-gray-500",children:"to"}),e.jsx("input",{type:"time",value:s.closes_at,onChange:r=>S(a,"closes_at",r.target.value),className:"px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]})]},s.day_of_week))}),e.jsx("div",{className:"mt-6",children:e.jsx(f,{variant:"primary",onClick:V,isLoading:T,children:"Save Working Hours"})})]})]})]})};export{pe as default};
